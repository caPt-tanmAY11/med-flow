generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model user {
  id            String     @unique
  name          String
  email         String     @unique
  emailVerified Boolean    @default(false)
  image         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  role          ROLE       @default(DOCTOR)
  uhid          String?    @unique
  department    DEPARTMENT?
  userRoles     UserRole[]
  account       account[]
  session       session[]
  opdQueues     OPDQueue[]
}

model verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([identifier])
}

model Patient {
  id                  String              @id @default(uuid())
  uhid                String              @unique
  name                String
  dob                 DateTime
  gender              Gender
  contact             String?
  email               String?
  aadhaarLast4        String?
  address             String?
  city                String?
  state               String?
  pincode             String?
  bloodGroup          String?
  emergencyName       String?
  emergencyContact    String?
  emergencyRelation   String?
  phoneHash           String?
  nameNormalized      String?
  isTemporary         Boolean             @default(false)
  tempExpiresAt       DateTime?
  offlineCreatedAt    DateTime?
  syncStatus          SyncStatus          @default(SYNCED)
  mergedIntoPatientId String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @default(now()) @updatedAt
  allergies           Allergy[]
  appointments        Appointment[]
  bills               Bill[]
  breakGlassAccesses  BreakGlassAccess[]
  clinicalNotes       ClinicalNote[]
  encounters          Encounter[]
  insurancePolicies   InsurancePolicy[]
  LabTestOrder        LabTestOrder[]
  OPDQueue            OPDQueue[]
  mergedIntoPatient   Patient?            @relation("PatientMerge", fields: [mergedIntoPatientId], references: [id])
  mergedPatients      Patient[]           @relation("PatientMerge")
  idDocuments         PatientIdDocument[]
  PatientImplant      PatientImplant[]
  prescriptions       Prescription[]
  riskAssessments     RiskAssessment[]
  vitalSigns          VitalSign[]
  medicalClassification String?
  socialHistory       SocialHistory?
  familyHistory       FamilyHistory[]

  @@index([phoneHash])
  @@index([nameNormalized])
  @@index([syncStatus])
}

model PatientIdDocument {
  id             String    @id @default(uuid())
  patientId      String
  documentType   String
  documentNumber String?
  fileUrl        String?
  verified       Boolean   @default(false)
  verifiedBy     String?
  verifiedAt     DateTime?
  createdAt      DateTime  @default(now())
  patient        Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model PatientMergeHistory {
  id              String   @id @default(uuid())
  sourcePatientId String
  targetPatientId String
  mergedBy        String
  mergedAt        DateTime @default(now())
  mergeReason     String?
  rollbackData    Json?
}

model Allergy {
  id           String    @id @default(uuid())
  patientId    String
  allergen     String
  allergenType String
  severity     String
  reaction     String?
  verifiedBy   String?
  verifiedAt   DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt
  patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model ClinicalNote {
  id          String                @id @default(uuid())
  encounterId String
  patientId   String
  noteType    String
  content     String
  authorId    String
  authorRole  String
  version     Int                   @default(1)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @default(now()) @updatedAt
  encounter   Encounter             @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  patient     Patient               @relation(fields: [patientId], references: [id], onDelete: Cascade)
  history     ClinicalNoteHistory[]

  @@index([encounterId])
  @@index([patientId])
  @@index([noteType])
}

model ClinicalNoteHistory {
  id             String       @id @default(uuid())
  clinicalNoteId String
  content        String
  authorId       String
  version        Int
  changedAt      DateTime     @default(now())
  clinicalNote   ClinicalNote @relation(fields: [clinicalNoteId], references: [id], onDelete: Cascade)

  @@index([clinicalNoteId])
}

model VitalSign {
  id             String    @id @default(uuid())
  encounterId    String
  patientId      String
  recordedAt     DateTime  @default(now())
  recordedBy     String
  temperature    Float?
  pulse          Int?
  respRate       Int?
  bpSystolic     Int?
  bpDiastolic    Int?
  spO2           Float?
  weight         Float?
  height         Float?
  painScore      Int?
  gcs            Int?
  notes          String?
  escalatedAt    DateTime?
  escalatedTo    String?
  escalationNote String?
  isCritical     Boolean   @default(false)
  verifiedWith   String?
  encounter      Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  patient        Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([patientId])
  @@index([recordedAt])
  @@index([isCritical])
}

model Prescription {
  id                   String                   @id @default(uuid())
  encounterId          String
  patientId            String
  prescribedBy         String
  prescribedAt         DateTime                 @default(now())
  status               String                   @default("active")
  prescriptionImageUrl String?
  encounter            Encounter                @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  patient              Patient                  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medications          PrescriptionMedication[]

  @@index([encounterId])
  @@index([patientId])
  @@index([status])
}

model PrescriptionMedication {
  id                        String                     @id @default(uuid())
  prescriptionId            String
  medicationId              String?
  medicationName            String
  dosage                    String
  frequency                 String
  route                     String
  duration                  String
  instructions              String?
  quantity                  Int?
  isDispensed               Boolean                    @default(false)
  medicationAdministrations MedicationAdministration[]
  prescription              Prescription               @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
}

model Consent {
  id          String   @id @default(uuid())
  patientId   String
  encounterId String?
  consentType String
  consentText String
  signedBy    String
  signedAt    DateTime @default(now())
  witnessedBy String?
  documentUrl String?
  isActive    Boolean  @default(true)

  @@index([patientId])
  @@index([encounterId])
}

model CarePlan {
  id            String   @id @default(uuid())
  encounterId   String
  patientId     String
  goals         Json
  interventions Json
  createdBy     String
  status        String   @default("active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  @@index([encounterId])
  @@index([patientId])
}

model MedicationAdministration {
  id                       String                 @id @default(uuid())
  prescriptionMedicationId String
  encounterId              String
  administeredBy           String
  administeredAt           DateTime               @default(now())
  dose                     String
  route                    String
  site                     String?
  status                   String
  notes                    String?
  verifiedBy               String?
  prescriptionMedication   PrescriptionMedication @relation(fields: [prescriptionMedicationId], references: [id], onDelete: Cascade)

  @@index([prescriptionMedicationId])
  @@index([encounterId])
}

model ShiftHandover {
  id             String    @id @default(uuid())
  encounterId    String
  outgoingNurse  String
  incomingNurse  String
  handoverAt     DateTime  @default(now())
  patientSummary String
  pendingTasks   Json
  alerts         Json
  acknowledgedAt DateTime?
  criticalAlerts Json?
  handoverNotes  String?


  @@index([encounterId])
  @@index([handoverAt])
}

model DischargeSummary {
  id                   String    @id @default(uuid())
  encounterId          String    @unique
  patientId            String
  admissionDiagnosis   String
  dischargeDiagnosis   String
  procedures           Json?
  courseOfTreatment    String
  conditionAtDischarge String
  followUpInstructions String?
  medications          Json?
  createdBy            String
  createdAt            DateTime  @default(now())
  approvedBy           String?
  approvedAt           DateTime?

  @@index([patientId])
}

model Appointment {
  id          String   @id @default(uuid())
  patientId   String
  doctorId    String
  department  String
  scheduledAt DateTime
  duration    Int      @default(15)
  status      String   @default("scheduled")
  visitType   String
  notes       String?
  encounterId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([doctorId])
  @@index([scheduledAt])
  @@index([status])
}

model Encounter {
  id                String               @id @default(uuid())
  patientId         String
  type              EncounterType
  status            EncounterStatus      @default(ACTIVE)
  primaryDoctorId   String?
  department        String?
  triageColor       TriageColor?
  triageNotes       String?
  triageBy          String?
  arrivalTime       DateTime             @default(now())
  triageTime        DateTime?
  consultationStart DateTime?
  consultationEnd   DateTime?
  treatmentStart    DateTime?
  treatmentEnd      DateTime?
  admissionTime     DateTime             @default(now())
  dischargeTime     DateTime?
  currentLocation   String?
  waitingFor        String?
  medicoLegalFlag   Boolean              @default(false)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @default(now()) @updatedAt
  bedAssignments    BedAssignment[]
  bills             Bill[]
  clinicalNotes     ClinicalNote[]
  patient           Patient              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  diagnoses         EncounterDiagnosis[]
  procedures        EncounterProcedure[]
  incidents         Incident[]
  orders            Order[]
  prescriptions     Prescription[]
  riskAssessments   RiskAssessment[]
  safetyAlerts      SafetyAlert[]
  surgeries         Surgery[]
  transfers         Transfer[]
  vitalSigns        VitalSign[]

  @@index([patientId])
  @@index([status])
  @@index([type])
  @@index([arrivalTime])
}

model Transfer {
  id            String    @id @default(uuid())
  encounterId   String
  fromLocation  String
  toLocation    String
  transferredAt DateTime  @default(now())
  transferredBy String
  reason        String?
  encounter     Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
}

model MedicoLegalCase {
  id            String   @id @default(uuid())
  encounterId   String   @unique
  caseType      String
  policeStation String?
  firNumber     String?
  reportedAt    DateTime @default(now())
  reportedBy    String
  mlcNotes      String?
  documentsUrl  String[]

  @@index([encounterId])
}

model OrderSet {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  category    String
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now()) @updatedAt
  items       OrderSetItem[]
}

model OrderSetItem {
  id            String   @id @default(uuid())
  orderSetId    String
  itemType      String
  itemCode      String
  itemName      String
  defaultValues Json?
  sortOrder     Int      @default(0)
  orderSet      OrderSet @relation(fields: [orderSetId], references: [id], onDelete: Cascade)

  @@index([orderSetId])
}

model Order {
  id              String           @id @default(uuid())
  encounterId     String
  patientId       String
  orderType       String
  orderCode       String
  orderName       String
  priority        Priority         @default(ROUTINE)
  orderedBy       String
  orderedAt       DateTime         @default(now())
  status          String           @default("ordered")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now()) @updatedAt
  labResult       LabResult?
  encounter       Encounter        @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  radiologyResult RadiologyResult?
  sample          Sample?

  @@index([encounterId])
  @@index([patientId])
  @@index([status])
  @@index([priority])
}

model Sample {
  id          String    @id @default(uuid())
  orderId     String    @unique
  sampleType  String
  collectedBy String
  collectedAt DateTime  @default(now())
  barcode     String    @unique
  status      String    @default("collected")
  receivedAt  DateTime?
  receivedBy  String?
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([barcode])
  @@index([status])
}

model LabResult {
  id                 String    @id @default(uuid())
  orderId            String    @unique
  resultedAt         DateTime  @default(now())
  resultedBy         String
  result             Json
  normalRange        String?
  interpretation     String?
  isCritical         Boolean   @default(false)
  criticalNotifiedAt DateTime?
  criticalNotifiedTo String?
  verifiedBy         String?
  verifiedAt         DateTime?
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model RadiologyResult {
  id          String    @id @default(uuid())
  orderId     String    @unique
  performedAt DateTime  @default(now())
  performedBy String
  findings    String
  impression  String
  imageUrls   String[]
  reportUrl   String?
  verifiedBy  String?
  verifiedAt  DateTime?
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Medication {
  id           String            @id @default(uuid())
  name         String
  genericName  String
  category     String
  form         String
  strength     String
  manufacturer String?
  isControlled Boolean           @default(false)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @default(now()) @updatedAt
  interactions DrugInteraction[]

  @@index([genericName])
  @@index([category])
}

model DrugInteraction {
  id            String     @id @default(uuid())
  medicationId  String
  interactsWith String
  severity      String
  description   String
  medication    Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  @@index([medicationId])
}

model InventoryItem {
  id           String             @id @default(uuid())
  itemType     String
  itemCode     String             @unique
  name         String
  category     String
  unit         String
  reorderLevel Int
  maxStock     Int
  currentStock Int                @default(0)
  location     String?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @default(now()) @updatedAt
  batches      InventoryBatch[]
  transactions StockTransaction[]

  @@index([itemCode])
  @@index([category])
  @@index([currentStock])
}

model InventoryBatch {
  id           String        @id @default(uuid())
  itemId       String
  batchNumber  String
  expiryDate   DateTime
  quantity     Int
  costPrice    Float
  sellingPrice Float?
  vendorId     String?
  grnId        String?
  createdAt    DateTime      @default(now())
  grn          GoodsReceipt? @relation(fields: [grnId], references: [id])
  item         InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  vendor       Vendor?       @relation(fields: [vendorId], references: [id])

  @@index([itemId])
  @@index([expiryDate])
  @@index([batchNumber])
}

model Vendor {
  id             String           @id @default(uuid())
  name           String
  contactPerson  String?
  phone          String?
  email          String?
  address        String?
  gstNumber      String?
  panNumber      String?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  batches        InventoryBatch[]
  purchaseOrders PurchaseOrder[]
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  vendorId    String
  poNumber    String              @unique
  status      String              @default("draft")
  totalAmount Float?
  createdBy   String
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @default(now()) @updatedAt
  grns        GoodsReceipt[]
  vendor      Vendor              @relation(fields: [vendorId], references: [id])
  items       PurchaseOrderItem[]

  @@index([vendorId])
  @@index([status])
}

model PurchaseOrderItem {
  id        String        @id @default(uuid())
  poId      String
  itemId    String
  quantity  Int
  unitPrice Float
  po        PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@index([poId])
}

model GoodsReceipt {
  id         String             @id @default(uuid())
  poId       String
  grnNumber  String             @unique
  receivedBy String
  receivedAt DateTime           @default(now())
  notes      String?
  po         PurchaseOrder      @relation(fields: [poId], references: [id])
  items      GoodsReceiptItem[]
  batches    InventoryBatch[]

  @@index([poId])
}

model GoodsReceiptItem {
  id          String       @id @default(uuid())
  grnId       String
  itemId      String
  batchNumber String
  quantity    Int
  expiryDate  DateTime
  grn         GoodsReceipt @relation(fields: [grnId], references: [id], onDelete: Cascade)

  @@index([grnId])
}

model StockTransaction {
  id              String        @id @default(uuid())
  itemId          String
  transactionType String
  quantity        Int
  batchNumber     String?
  encounterId     String?
  patientId       String?
  performedBy     String
  performedAt     DateTime      @default(now())
  notes           String?
  item            InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([transactionType])
}

model DrugRecall {
  id           String   @id @default(uuid())
  batchNumber  String
  medicationId String
  reason       String
  recalledAt   DateTime @default(now())
  actionTaken  String?
}

model Bed {
  id            String          @id @default(uuid())
  bedNumber     String          @unique
  ward          String
  floor         Int?
  type          String
  status        BedStatus       @default(AVAILABLE)
  lastCleanedAt DateTime?
  lastCleanedBy String?
  features      String[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  assignments   BedAssignment[]

  @@index([ward])
  @@index([status])
  @@index([type])
}

model BedAssignment {
  id          String    @id @default(uuid())
  encounterId String
  bedId       String
  startTime   DateTime  @default(now())
  endTime     DateTime?
  assignedBy  String?
  bed         Bed       @relation(fields: [bedId], references: [id])
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([bedId])
}

model Surgery {
  id                String            @id @default(uuid())
  patientId         String
  encounterId       String
  procedureName     String
  procedureCode     String?
  scheduledDate     DateTime
  scheduledTime     String
  estimatedDuration Int
  actualStartTime   DateTime?
  actualEndTime     DateTime?
  status            String            @default("scheduled")
  otRoom            String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @default(now()) @updatedAt
  anesthesiaRecord  AnesthesiaRecord?
  checklists        OTChecklist[]
  consumables       OTConsumable[]
  encounter         Encounter         @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  notes             SurgeryNote[]
  surgeryTeam       SurgeryTeam[]

  @@index([patientId])
  @@index([encounterId])
  @@index([scheduledDate])
  @@index([status])
}

model SurgeryTeam {
  id        String  @id @default(uuid())
  surgeryId String
  staffId   String
  staffName String
  role      String
  surgery   Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model OTChecklist {
  id            String    @id @default(uuid())
  surgeryId     String
  checklistType String
  items         Json
  completedBy   String?
  completedAt   DateTime?
  surgery       Surgery   @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model AnesthesiaRecord {
  id             String  @id @default(uuid())
  surgeryId      String  @unique
  anesthesiaType String
  preAssessment  Json
  intraOpVitals  Json
  medications    Json
  events         Json
  recovery       Json?
  surgery        Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
}

model OTConsumable {
  id           String  @id @default(uuid())
  surgeryId    String
  itemType     String
  itemName     String
  quantity     Int
  serialNumber String?
  batchNumber  String?
  cost         Float?
  surgery      Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model SurgeryNote {
  id        String   @id @default(uuid())
  surgeryId String
  noteType  String
  content   String
  authorId  String
  createdAt DateTime @default(now())
  surgery   Surgery  @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model Equipment {
  id                String    @id @default(uuid())
  name              String
  category          String
  serialNumber      String?
  assetTag          String?
  location          String
  status            String    @default("available")
  lastMaintenanceAt DateTime?
  nextMaintenanceAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt

  @@index([status])
  @@index([category])
}

model StaffShift {
  id         String   @id @default(uuid())
  staffId    String
  staffName  String
  department String
  shiftType  String
  startTime  DateTime
  endTime    DateTime
  status     String   @default("scheduled")
  createdAt  DateTime @default(now())

  @@index([staffId])
  @@index([startTime])
  @@index([department])
}

model ResourceUtilization {
  id              String   @id @default(uuid())
  resourceType    String
  resourceId      String
  utilizationDate DateTime
  hoursUsed       Float
  hoursAvailable  Float
  notes           String?

  @@index([resourceType])
  @@index([utilizationDate])
}

model Bill {
  id             String           @id @default(uuid())
  billNumber     String           @unique
  patientId      String
  encounterId    String
  status         String           @default("draft")
  subtotal       Float
  discountAmount Float            @default(0)
  taxAmount      Float            @default(0)
  totalAmount    Float
  paidAmount     Float            @default(0)
  balanceDue     Float
  finalizedAt    DateTime?
  finalizedBy    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  encounter      Encounter        @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  patient        Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  discounts      BillDiscount[]
  items          BillItem[]
  claims         InsuranceClaim[]
  payments       Payment[]

  @@index([patientId])
  @@index([encounterId])
  @@index([status])
}

model BillItem {
  id          String  @id @default(uuid())
  billId      String
  category    String
  itemCode    String?
  description String
  quantity    Int     @default(1)
  unitPrice   Float
  totalPrice  Float
  tariffId    String?
  department  String?
  bill        Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId])
  @@index([department])
}

model TariffMaster {
  id            String    @id @default(uuid())
  tariffCode    String    @unique
  category      String
  description   String
  basePrice     Float
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  @@index([category])
  @@index([isActive])
}

model BillDiscount {
  id            String    @id @default(uuid())
  billId        String
  discountType  String
  discountValue Float
  reason        String?
  approvedBy    String?
  approvedAt    DateTime?
  status        String    @default("pending")
  bill          Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId])
  @@index([status])
}

model Payment {
  id              String   @id @default(uuid())
  billId          String
  amount          Float
  paymentMode     String
  referenceNumber String?
  receivedBy      String
  receivedAt      DateTime @default(now())
  bill            Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId])
}

model InsurancePolicy {
  id                String             @id @default(uuid())
  patientId         String
  insurerId         String
  insurerName       String
  policyNumber      String
  policyType        String
  sumInsured        Float
  validFrom         DateTime
  validTo           DateTime
  tpaName           String?
  tpaCode           String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now()) @updatedAt
  claims            InsuranceClaim[]
  patient           Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  preAuthorizations PreAuthorization[]

  @@index([patientId])
  @@index([policyNumber])
}

model PreAuthorization {
  id              String          @id @default(uuid())
  encounterId     String
  policyId        String
  requestedAmount Float
  approvedAmount  Float?
  status          String          @default("pending")
  requestedAt     DateTime        @default(now())
  respondedAt     DateTime?
  remarks         String?
  documents       String[]
  policy          InsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([policyId])
  @@index([status])
}

model InsuranceClaim {
  id              String          @id @default(uuid())
  billId          String
  policyId        String
  claimAmount     Float
  approvedAmount  Float?
  status          String          @default("submitted")
  submittedAt     DateTime        @default(now())
  settledAt       DateTime?
  rejectionReason String?
  documents       String[]
  bill            Bill            @relation(fields: [billId], references: [id], onDelete: Cascade)
  policy          InsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([billId])
  @@index([policyId])
  @@index([status])
}

model ClinicalCode {
  id          String   @id @default(uuid())
  codeSystem  String
  code        String
  description String
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@unique([codeSystem, code])
  @@index([codeSystem])
}

model EncounterDiagnosis {
  id          String    @id @default(uuid())
  encounterId String
  codeId      String?
  isPrimary   Boolean   @default(false)
  codeSystem  String
  code        String
  description String
  codedBy     String
  codedAt     DateTime  @default(now())
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
}

model EncounterProcedure {
  id          String    @id @default(uuid())
  encounterId String
  codeId      String?
  codeSystem  String
  code        String
  description String
  performedAt DateTime?
  codedBy     String
  codedAt     DateTime  @default(now())
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
}

model SafetyAlert {
  id             String     @id @default(uuid())
  patientId      String
  encounterId    String?
  alertType      String
  severity       String
  message        String
  context        Json?
  triggeredAt    DateTime   @default(now())
  acknowledgedBy String?
  acknowledgedAt DateTime?
  overrideReason String?
  encounter      Encounter? @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([encounterId])
  @@index([alertType])
  @@index([severity])
}

model Incident {
  id             String                  @id @default(uuid())
  incidentType   String
  severity       String
  location       String
  description    String
  reportedBy     String
  reportedAt     DateTime                @default(now())
  patientId      String?
  encounterId    String?
  status         String                  @default("reported")
  rootCause      String?
  resolvedAt     DateTime?
  resolvedBy     String?
  capa           CAPA[]
  encounter      Encounter?              @relation(fields: [encounterId], references: [id])
  investigations IncidentInvestigation[]

  @@index([incidentType])
  @@index([severity])
  @@index([status])
}

model IncidentInvestigation {
  id             String   @id @default(uuid())
  incidentId     String
  investigator   String
  findings       String
  investigatedAt DateTime @default(now())
  incident       Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
}

model RiskAssessment {
  id             String    @id @default(uuid())
  patientId      String
  encounterId    String
  assessmentType String
  score          Int
  riskLevel      String
  assessedBy     String
  assessedAt     DateTime  @default(now())
  interventions  String[]
  encounter      Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  patient        Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([encounterId])
  @@index([riskLevel])
}

model CAPA {
  id            String    @id @default(uuid())
  incidentId    String?
  capaType      String
  description   String
  assignedTo    String
  dueDate       DateTime
  status        String    @default("open")
  completedAt   DateTime?
  verifiedBy    String?
  verifiedAt    DateTime?
  effectiveness String?
  incident      Incident? @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([status])
  @@index([dueDate])
}

model InfectionControl {
  id            String    @id @default(uuid())
  patientId     String
  encounterId   String
  infectionType String
  organism      String?
  isolationType String?
  identifiedAt  DateTime  @default(now())
  resolvedAt    DateTime?
  notes         String?

  @@index([patientId])
  @@index([encounterId])
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id          String           @id @default(uuid())
  resource    String
  action      String
  description String?
  roles       RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedBy String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model AuditEvent {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  action      String
  performedBy String
  performedAt DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  oldValues   Json?
  newValues   Json?
  metadata    Json?

  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([performedAt])
  @@index([action])
}

model BreakGlassAccess {
  id          String    @id @default(uuid())
  userId      String
  patientId   String
  reason      String
  accessedAt  DateTime  @default(now())
  expiresAt   DateTime
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([patientId])
  @@index([accessedAt])
}

model DashboardConfig {
  id            String   @id @default(uuid())
  roleId        String?
  userId        String?
  dashboardType String
  widgets       Json
  layout        Json
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  @@index([roleId])
  @@index([userId])
}

model NurseDuty {
  id         String    @id @default(uuid())
  nurseId    String
  nurseName  String
  shiftType  String
  shiftDate  DateTime
  checkInAt  DateTime?
  checkOutAt DateTime?
  isActive   Boolean   @default(true)
  ward       String?
  createdAt  DateTime  @default(now())
  secretCode String?

  @@index([nurseId])
  @@index([shiftDate])
  @@index([isActive])
}

model NursePatientAssignment {
  id          String    @id @default(uuid())
  nurseId     String
  nurseName   String
  encounterId String
  patientId   String
  assignedAt  DateTime  @default(now())
  assignedBy  String
  endTime     DateTime?
  isActive    Boolean   @default(true)

  @@index([nurseId])
  @@index([encounterId])
  @@index([patientId])
  @@index([isActive])
}

model NurseDailyCode {
  id        String   @id @default(uuid())
  code      String
  validDate DateTime
  createdBy String
  createdAt DateTime @default(now())
  isActive  Boolean  @default(true)

  @@index([validDate])
  @@index([isActive])
}

model NurseVerification {
  id         String   @id @default(uuid())
  nurseId    String
  nurseName  String
  verifiedAt DateTime @default(now())
  codeUsed   String
  ipAddress  String?
  shiftDate  DateTime

  @@index([nurseId])
  @@index([verifiedAt])
  @@index([shiftDate])
}

model Notification {
  id          String    @id @default(uuid())
  userId      String
  title       String
  message     String
  type        String    @default("info")
  link        String?
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  encounterId String?
  patientId   String?

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model ExternalLabClient {
  id                  String                @id
  name                String
  code                String                @unique
  contactPerson       String?
  phone               String?
  email               String?
  address             String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  ExternalLabReferral ExternalLabReferral[]
}

model ExternalLabReferral {
  id                String            @id
  clientId          String
  patientName       String
  patientAge        Int?
  patientGender     String?
  testCodes         String[]
  status            String            @default("pending")
  receivedAt        DateTime          @default(now())
  completedAt       DateTime?
  reportUrls        String[]
  notes             String?
  ExternalLabClient ExternalLabClient @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([status])
}

model LabInventoryItem {
  id           String    @id
  itemCode     String    @unique
  name         String
  category     String
  unit         String
  currentStock Int       @default(0)
  minStock     Int       @default(10)
  maxStock     Int?
  unitCost     Float?
  expiryDate   DateTime?
  location     String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())

  @@index([category])
  @@index([currentStock])
}

model LabTest {
  id                 String               @id
  code               String               @unique
  name               String
  category           String
  type               String
  description        String?
  price              Float
  discountedPrice    Float?
  prerequisites      Json
  sampleType         String?
  turnaroundTime     String
  isActive           Boolean              @default(true)
  isHomeCollection   Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now())
  LabTestOrder       LabTestOrder[]
  LabTestResultField LabTestResultField[]

  @@index([category])
  @@index([isActive])
  @@index([type])
}

model LabTestOrder {
  id              String    @id
  patientId       String
  testId          String
  status          String    @default("cart")
  priority        Priority  @default(ROUTINE)
  prescriptionUrl String?
  scheduledDate   DateTime?
  notes           String?
  hasAllergies    Boolean   @default(false)
  allergyNotes    String?
  hasImplants     Boolean   @default(false)
  implantDetails  String?
  assignedTo      String?
  barcode         String?   @unique
  collectedAt     DateTime?
  collectedBy     String?
  resultData      Json?
  resultedAt      DateTime?
  resultedBy      String?
  reportUrl       String?
  isCritical      Boolean   @default(false)
  verifiedAt      DateTime?
  verifiedBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now())
  Patient         Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  LabTest         LabTest   @relation(fields: [testId], references: [id])

  @@index([barcode])
  @@index([createdAt])
  @@index([patientId])
  @@index([status])
}

model LabTestResultField {
  id         String   @id
  testId     String
  fieldName  String
  fieldLabel String
  fieldType  String
  unit       String?
  normalMin  Float?
  normalMax  Float?
  options    String[]
  isRequired Boolean  @default(true)
  sortOrder  Int      @default(0)
  LabTest    LabTest  @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
}

model OPDQueue {
  id          String   @id
  doctorId    String
  patientId   String
  tokenNumber Int
  status      String   @default("WAITING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  user        user     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  Patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([doctorId])
  @@index([status])
}

model PatientImplant {
  id           String    @id
  patientId    String
  type         String
  location     String
  mriSafe      Boolean?
  details      String?
  dateInserted DateTime?
  documentUrl  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())
  Patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model NurseDuty {
  id         String    @id @default(uuid())
  nurseId    String
  nurseName  String
  shiftType  String
  shiftDate  DateTime
  checkInAt  DateTime?
  checkOutAt DateTime?
  isActive   Boolean   @default(true)
  ward       String?
  createdAt  DateTime  @default(now())
  secretCode String?

  @@index([nurseId])
  @@index([shiftDate])
  @@index([isActive])
}

model NursePatientAssignment {
  id          String    @id @default(uuid())
  nurseId     String
  nurseName   String
  encounterId String
  patientId   String
  type        String   // pacemaker, cochlear_implant, metal_plates, etc.
  location    String
  mriSafe     Boolean?
  details     String?
  dateInserted DateTime?
  documentUrl String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([isActive])
}

model NurseDailyCode {
  id        String   @id @default(uuid())
  code      String
  validDate DateTime
  createdBy String
  createdAt DateTime @default(now())
  isActive  Boolean  @default(true)

  @@index([validDate])
  @@index([isActive])
}

model NurseVerification {
  id         String   @id @default(uuid())
  nurseId    String
  nurseName  String
  verifiedAt DateTime @default(now())
  codeUsed   String
  ipAddress  String?
  shiftDate  DateTime

  @@index([nurseId])
  @@index([verifiedAt])
  @@index([shiftDate])
}

model Notification {
  id          String    @id @default(uuid())
  userId      String
  title       String
  message     String
  type        String    @default("info")
  link        String?
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  encounterId String?
  patientId   String?

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model ExternalLabClient {
  id                  String                @id
  name                String
  code                String                @unique
  contactPerson       String?
  phone               String?
  email               String?
  address             String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  ExternalLabReferral ExternalLabReferral[]
}

model ExternalLabReferral {
  id                String            @id
  clientId          String
  patientName       String
  patientAge        Int?
  patientGender     String?
  testCodes         String[]
  status            String            @default("pending")
  receivedAt        DateTime          @default(now())
  completedAt       DateTime?
  reportUrls        String[]
  notes             String?
  ExternalLabClient ExternalLabClient @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([status])
}

model LabInventoryItem {
  id           String    @id
  itemCode     String    @unique
  name         String
  category     String
  unit         String
  currentStock Int       @default(0)
  minStock     Int       @default(10)
  maxStock     Int?
  unitCost     Float?
  expiryDate   DateTime?
  location     String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())

  @@index([category])
  @@index([currentStock])
}

model LabTest {
  id                 String               @id
  code               String               @unique
  name               String
  category           String
  type               String
  description        String?
  price              Float
  discountedPrice    Float?
  prerequisites      Json
  sampleType         String?
  turnaroundTime     String
  isActive           Boolean              @default(true)
  isHomeCollection   Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now())
  LabTestOrder       LabTestOrder[]
  LabTestResultField LabTestResultField[]

  @@index([category])
  @@index([isActive])
  @@index([type])
}

model LabTestOrder {
  id              String    @id
  patientId       String
  testId          String
  status          String    @default("cart")
  priority        Priority  @default(ROUTINE)
  prescriptionUrl String?
  scheduledDate   DateTime?
  notes           String?
  hasAllergies    Boolean   @default(false)
  allergyNotes    String?
  hasImplants     Boolean   @default(false)
  implantDetails  String?
  assignedTo      String?
  barcode         String?   @unique
  collectedAt     DateTime?
  collectedBy     String?
  resultData      Json?
  resultedAt      DateTime?
  resultedBy      String?
  reportUrl       String?
  isCritical      Boolean   @default(false)
  verifiedAt      DateTime?
  verifiedBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now())
  Patient         Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  LabTest         LabTest   @relation(fields: [testId], references: [id])

  @@index([barcode])
  @@index([createdAt])
  @@index([patientId])
  @@index([status])
}

model LabTestResultField {
  id         String   @id
  testId     String
  fieldName  String
  fieldLabel String
  fieldType  String
  unit       String?
  normalMin  Float?
  normalMax  Float?
  options    String[]
  isRequired Boolean  @default(true)
  sortOrder  Int      @default(0)
  LabTest    LabTest  @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
}

model OPDQueue {
  id          String   @id
  doctorId    String
  patientId   String
  tokenNumber Int
  status      String   @default("WAITING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  user        user     @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  Patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([doctorId])
  @@index([status])
}

model PatientImplant {
  id           String    @id
  patientId    String
  type         String
  location     String
  mriSafe      Boolean?
  details      String?
  dateInserted DateTime?
  documentUrl  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())
  Patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

enum EncounterType {
  OPD
  IPD
  EMERGENCY
}

enum EncounterStatus {
  ACTIVE
  TRANSFERRED
  DISCHARGED
  CANCELLED
}

enum BedStatus {
  AVAILABLE
  OCCUPIED
  CLEANING
  MAINTENANCE
  RESERVED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Priority {
  STAT
  URGENT
  ROUTINE
}

enum TriageColor {
  RED
  ORANGE
  YELLOW
  GREEN
}

enum SyncStatus {
  SYNCED
  PENDING
  CONFLICT
}

enum ROLE {
  DOCTOR
  NURSE
  LAB_PERSON
  ADMIN
  NURSING_ADMIN
  PATIENT
  FRONT_DESK
  PHARMACIST
  BILLING
  MANAGEMENT
}

enum DEPARTMENT {
  GENERAL_MEDICINE
  CARDIOLOGY
  ORTHOPEDICS
  PEDIATRICS
  DERMATOLOGY
  GYNECOLOGY
  ENT
}

model SocialHistory {
  id             String   @id @default(uuid())
  patientId      String   @unique
  smoking        String?
  alcohol        String?
  diet           String?
  exercise       String?
  occupation     String? // employment
  maritalStatus  String?
  educationLevel String?
  stressLevel    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt
  patient        Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model FamilyHistory {
  id         String   @id @default(uuid())
  patientId  String
  relation   String
  condition  String
  ageAtOnset Int?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}
